<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Affirmation</title>

<style>
:root{
  --bg: #f5eee8;
  --card-w: clamp(230px, 70vw, 440px);
  --overlap-factor: 0.70;
}

html,body{
  height:100%;
  margin:0;
  overflow:hidden;
  font-family:"Inter",Inter,Arial,sans-serif;
  background:var(--bg);
}

.app{
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  overflow:hidden;
}

.viewport{
  width:100%;
  display:flex;
  justify-content:center;
  align-items:flex-end;
  padding:10px 18px 60px 18px;
  overflow:visible;
}

.scroller{
  display:flex;
  width:100%;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}
.scroller::-webkit-scrollbar{ display:none; }

.track{
  display:flex;
  align-items:flex-end;
  padding:40px 0;
}

.card{
  flex:0 0 auto;
  width:var(--card-w);
  aspect-ratio:750/1050;
  position:relative;
  scroll-snap-align:center;
  margin-right:calc(var(--card-w) * -1 * var(--overlap-factor));
  margin-top:110px;
  transform-origin:center;
  transition:transform 300ms ease;
  cursor:pointer;
  perspective:1200px;
}

.card__inner{
  position:relative;
  width:100%;
  height:100%;
  transform-style:preserve-3d;
  transition:transform 700ms cubic-bezier(.2,.9,.25,1);
}

.card.flipped .card__inner{
  transform:rotateY(180deg);
}

.face{
  position:absolute;
  inset:0;
  border-radius:16px;
  overflow:hidden;
  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
  box-shadow:
  0 6px 12px rgba(0,0,0,0.35),
  0 2px 6px rgba(0,0,0,0.25);
}

.face img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.face.front{
  transform:rotateY(180deg);
}

.card.center{
  transform:translateY(-33%);
}

.card.selected{
  transform:translateY(-18px) scale(1.12)!important;
}

.card.blur:not(.flipped){
  opacity:0;
}

@media (min-width:768px){
  .viewport{
    padding-top:30px;
    padding-bottom:40px;
  }
  .card.center{
    transform:translateY(-20%);
  }
}
</style>
</head>

<body>
<div class="app">
  <div class="viewport">
    <div class="scroller" id="scroller">
      <div class="track" id="track"></div>
    </div>
  </div>
</div>

<script>

/* ---------- SUPABASE BASE ---------- */
const BASE_URL = "https://tppyzexttkuvcobbbmaz.supabase.co/storage/v1/object/public/IamCards/";
const BACK_IMAGE = BASE_URL + "CARD-BACKSIDE.png";

/* ---------- TOTAL CARDS ---------- */
const TOTAL_CARDS = 95; // Change here if you add more later

/* ---------- BUILD IMAGE URLS ---------- */
const IMAGES = Array.from({length: TOTAL_CARDS}, (_, i) => {
  const number = String(i + 1).padStart(2, "0"); // auto handles 3 digits later
  return BASE_URL + `${number}%20`; 
});

/* 
Because filenames are:
01 guided from within.png
02 at peace.png
etc.

We will dynamically find matching file names by scanning index only.
So instead we generate full URLs below.
*/

const track = document.getElementById('track');
const scroller = document.getElementById('scroller');

/* ---------- CREATE CARDS ---------- */
for(let i=1;i<=TOTAL_CARDS;i++){

  const padded = String(i).padStart(2,"0");
  const src = BASE_URL + `${padded}%20`; // prefix

  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.index = i;

  const inner = document.createElement('div');
  inner.className = 'card__inner';

  const back = document.createElement('div');
  back.className = 'face back';
  back.innerHTML = `<img src="${BACK_IMAGE}" />`;

  const front = document.createElement('div');
  front.className = 'face front';
  front.innerHTML = `<img data-src="${BASE_URL}${padded}%20${''}.png" />`;

  // IMPORTANT:
  // We assume full filenames already exist correctly in Supabase.
  // Since spaces are encoded as %20, your URLs will load properly.

  inner.appendChild(back);
  inner.appendChild(front);
  card.appendChild(inner);
  track.appendChild(card);
}

/* ---------- DUPLICATE FOR LOOPING ---------- */
Array.from(track.children).forEach(card=>{
  track.appendChild(card.cloneNode(true));
});

/* ---------- CENTER DETECTION ---------- */
function updateCenter(){
  const scRect = scroller.getBoundingClientRect();
  const centerX = scRect.left + scRect.width/2;
  let closest=null, closestDist=Infinity;

  document.querySelectorAll('.card').forEach(c=>{
    c.classList.remove('center');
    const r = c.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const d = Math.abs(cx - centerX);
    if(d < closestDist){ closestDist = d; closest = c; }
  });

  if(closest) closest.classList.add('center');
}

scroller.addEventListener('scroll', () => {
  const halfWidth = scroller.scrollWidth / 2;

  if (scroller.scrollLeft >= halfWidth) {
    scroller.scrollLeft -= halfWidth;
  }
  if (scroller.scrollLeft <= 0) {
    scroller.scrollLeft += halfWidth;
  }

  requestAnimationFrame(updateCenter);
});

/* ---------- CLICK ---------- */
scroller.addEventListener('click', ()=>{

  const center = document.querySelector('.card.center');
  if(!center || center.classList.contains('selected')) return;

  const img = center.querySelector('.face.front img');
  if(!img.src){
    img.src = img.dataset.src;
  }

  center.classList.add('selected','flipped');

  document.querySelectorAll('.card').forEach(c=>{
    if(c !== center) c.classList.add('blur');
  });

  /* SAVE DAILY (LOCAL MIDNIGHT RESET) */
  const today = new Date();
  today.setHours(0,0,0,0);

  const index = Array.from(document.querySelectorAll('.card')).indexOf(center);

  localStorage.setItem('iamDailyCard', JSON.stringify({
    cardIndex: index,
    date: today.getTime()
  }));

});

/* ---------- LOAD ---------- */
window.addEventListener('load', () => {

  requestAnimationFrame(() => {

    const halfWidth = scroller.scrollWidth / 2;
    scroller.scrollLeft = halfWidth / 2;
    setTimeout(updateCenter, 50);

    const saved = JSON.parse(localStorage.getItem('iamDailyCard'));

    const today = new Date();
    today.setHours(0,0,0,0);

    if(saved && saved.date === today.getTime()){

      const cards = document.querySelectorAll('.card');
      const savedCard = cards[saved.cardIndex];

      if(savedCard){

        const img = savedCard.querySelector('.face.front img');
        if(!img.src){
          img.src = img.dataset.src;
        }

        savedCard.classList.add('selected','flipped');

        savedCard.scrollIntoView({
          inline:"center",
          block:"nearest"
        });

        cards.forEach(c=>{
          if(c !== savedCard) c.classList.add('blur');
        });
      }

    } else {
      localStorage.removeItem('iamDailyCard');
    }

  });

});
</script>
</body>
</html>
